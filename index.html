<!doctype html>
<html lang="si">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>උපදේශන පත්‍රය — Flexico</title>
  <style>
    :root{
      --card-bg: #fff;
      --page-bg: #f4f6f8;
      --accent: #0b63d6;
      --muted: #666;
      --field-bg: #fbfdff;
      --max-width: 900px;
      font-family: "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, sans-serif;
      color: #111;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--page-bg);
      padding:20px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .container{
      max-width:var(--max-width);
      margin:0 auto;
    }

    .card{
      background:var(--card-bg);
      border-radius:10px;
      box-shadow:0 6px 18px rgba(15,30,60,0.08);
      padding:28px;
      margin-bottom:20px;
    }

    header{
      display:flex;
      align-items:center;
      gap:18px;
      margin-bottom:18px;
    }

    .logo{
      width:64px;height:64px;border-radius:8px;
      background:linear-gradient(135deg,var(--accent) 0%, #4aa3ff 100%);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
      font-size:18px;
    }

    h1{
      margin:0;
      font-size:20px;
      letter-spacing:0.2px;
    }
    p.lead{
      margin:8px 0 18px 0;
      color:var(--muted);
      line-height:1.45;
      font-size:14px;
    }

    .declaration{
      font-size:16px;
      margin: 12px 0 20px 0;
      line-height:1.7;
      color:#111;
    }

    form {
      display:block;
      gap:14px;
    }

    .field-row{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
    }

    .field{
      flex:1 1 260px;
      display:flex;
      flex-direction:column;
      margin-bottom:12px;
    }

    label{
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
    }

    input[type="text"], input[type="number"], textarea {
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #e0e6ef;
      background:var(--field-bg);
      font-size:15px;
      outline:none;
    }
    textarea{
      min-height:100px;
      resize:vertical;
    }

    .signature-box{
      border:2px dashed #d9e2f7;
      border-radius:8px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      background:linear-gradient(180deg, rgba(250,252,255,1), rgba(245,249,255,1));
    }

    canvas#sig{
      width:100%;
      height:200px;
      background:#fff;
      border-radius:6px;
      border:1px solid #dfe9ff;
      touch-action: none;
    }

    .sig-controls{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }

    button{
      padding:10px 14px;
      border-radius:8px;
      border:0;
      background:var(--accent);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(11,99,214,0.12);
    }
    button.secondary{
      background:#6b7280;
      box-shadow:none;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
    }

    .actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }

    /* print styles */
    @media print{
      body{background:#fff;padding:0}
      .card{box-shadow:none;border-radius:0;padding:0}
      .logo, .sig-controls, .actions, .lead {display:none}
      canvas#sig{border:none;height:150px}
    }

    /* small screens adjustments */
    @media (max-width:560px){
      header{gap:12px}
      .logo{width:52px;height:52px;font-size:16px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-label="Loan declaration form">
      <header>
        <div class="logo">flexico</div>
        <div>
          <h1>Flexico ආයතනයෙන් ණය තහවුරු කිරීම</h1>
          <p class="lead">මෙම පත්‍රයෙන් ඔබ විසින් ලබාගන්නා ණය සහ ඔබගේ වගකීම් තහවුරු කෙරේ.</p>
        </div>
      </header>

      <div class="declaration">
        <p><strong>flexico ආයතනයෙන් මඟින් ඔබගේ ණය මුදල තහවුරු කර ඇත..</strong></p>

        <form id="loanForm" onsubmit="return handleSubmit(event)">
          <div class="field-row">
            <div class="field">
              <label for="recipientName">ලබාගන්නා පුද්ගලයාගේ නම</label>
              <input id="recipientName" name="recipientName" type="text" placeholder="උදාහරණය: සුනිල් පෙරේරා" required>
            </div>

            <div class="field">
              <label for="loanAmount">ලබාගන්නා ණය මුදල (රු)</label>
              <input id="loanAmount" name="loanAmount" type="text" placeholder="e.g., 150,000.00" required>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="nic">ලබාගන්නා පුද්ගලයාගේ ජාතික අඳුරුම්පත් අංකය</label>
              <input id="nic" name="nic" type="text" placeholder="පුරවැසි හැඳුනුම්පත් අංකය / NIC" required>
            </div>

            <div class="field">
              <label for="date">දිනය</label>
              <input id="date" name="date" type="text" placeholder="" value="" >
            </div>
          </div>

          <p class="muted">මෙම ණය මුදල මා විසින් ලබා ගන්නා අතර. කිසිදු වංචාවක් හෝ පෙරහැරීමක් නොකරන මා විසින් පොරොන්දුවෙමි. එහෙම පැහැරහැරීමක් කිරීමක් හෝ කිසියම් වංචාවක් කරහොත් මා විසින් වගකීම ලබා ගන්නා බව පොරොදු වෙනවා.</p>

          <div style="margin-top:12px;" class="signature-box" aria-label="Signature area">
            <label class="muted">මෙතන අත්සන් කරන්න (mouse/touch)</label>
            <canvas id="sig"></canvas>
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
              <div class="muted">අත්සනය සුරකින්න හෝ මුද්‍රණය කරන්න.</div>
              <div class="sig-controls">
                <button type="button" class="secondary" id="clearBtn">Clear</button>
                <button type="button" id="saveBtn">Save Signature</button>
              </div>
            </div>
          </div>

          <div class="actions">
            <div class="muted">අත්සන් සටහන .png ලෙස සුරකින්න.</div>
            <div style="display:flex;gap:8px">
              <button type="submit">Submit</button>
              <button type="button" class="secondary" id="printBtn">Print</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  // set today's date into date field (ISO style) but shown as dd/mm/yyyy
  (function setDate(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yy = d.getFullYear();
    const el = document.getElementById('date');
    if(el) el.value = dd + '/' + mm + '/' + yy;
  })();

  // Signature pad (minimal)
  const canvas = document.getElementById('sig');
  const clearBtn = document.getElementById('clearBtn');
  const saveBtn = document.getElementById('saveBtn');
  const ctx = canvas.getContext('2d');

  // resize canvas for device pixel ratio
  function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const styles = getComputedStyle(canvas);
    const w = parseInt(styles.width);
    const h = parseInt(styles.height);
    canvas.width = w * ratio;
    canvas.height = h * ratio;
    canvas.getContext('2d').scale(ratio, ratio);
    // optional: white background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0, canvas.width/ratio, canvas.height/ratio);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  let drawing = false;
  let last = {x:0,y:0};

  function pointerPos(e){
    const rect = canvas.getBoundingClientRect();
    let clientX, clientY;
    if (e.touches && e.touches.length) {
      clientX = e.touches[0].clientX;
      clientY = e.touches[0].clientY;
    } else {
      clientX = e.clientX;
      clientY = e.clientY;
    }
    return {
      x: clientX - rect.left,
      y: clientY - rect.top
    };
  }

  canvas.addEventListener('pointerdown', (e) => {
    drawing = true;
    const p = pointerPos(e);
    last = p;
  });
  canvas.addEventListener('pointermove', (e) => {
    if(!drawing) return;
    const p = pointerPos(e);
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 2.4;
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
  });
  ['pointerup','pointercancel','pointerout'].forEach(ev => {
    canvas.addEventListener(ev, ()=> drawing=false);
  });

  clearBtn.addEventListener('click', () => {
    const styles = getComputedStyle(canvas);
    ctx.clearRect(0,0, canvas.width, canvas.height);
    // redraw white background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0, canvas.width, canvas.height);
  });

  saveBtn.addEventListener('click', () => {
    // convert to data URL and download
    const data = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = data;
    a.download = 'signature.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // handle form submit: collect data including signature image
  function handleSubmit(e){
    e.preventDefault();
    const name = document.getElementById('recipientName').value.trim();
    const amount = document.getElementById('loanAmount').value.trim();
    const nic = document.getElementById('nic').value.trim();
    const date = document.getElementById('date').value.trim();

    // get signature as dataURL
    const sigData = canvas.toDataURL('image/png');

    // Minimal client-side validation: ensure canvas not blank
    // Check if canvas is blank by comparing to empty white canvas
    const blank = isCanvasBlank(canvas);
    if(blank){
      if(!confirm('අත්සන නොමැති: ඔබ සටහන් කර නැද්ද? (OK = Submit anyway)')) {
        return false;
      }
    }

    // Here you can send data to server via fetch/XHR.
    // For demo, we open a new window with printable summary including signature.
    const win = window.open('', '_blank');
    const html = `
      <html><head><meta charset="utf-8"><title>Declaration - Print</title>
      <style>
        body{font-family: Arial, Helvetica, sans-serif; padding:20px; color:#111}
        .box{max-width:700px;margin:0 auto}
        h2{color:#0b63d6}
        .row{margin:12px 0}
        .label{color:#555;font-size:13px}
        .val{font-weight:700;margin-top:6px}
        .sig{margin-top:18px;border:1px solid #ddd;padding:8px;display:inline-block}
      </style>
      </head><body>
      <div class="box">
        <h2>Flexico — ණය තහවුරු කිරීම</h2>
        <div class="row"><div class="label">ලබාගන්නා පුද්ගලයාගේ නම</div><div class="val">${escapeHtml(name)}</div></div>
        <div class="row"><div class="label">ලබාගන්නා ණය මුදල</div><div class="val">${escapeHtml(amount)}</div></div>
        <div class="row"><div class="label">ජා.අන්.අංකය</div><div class="val">${escapeHtml(nic)}</div></div>
        <div class="row"><div class="label">දිනය</div><div class="val">${escapeHtml(date)}</div></div>
        <div class="row"><div class="label">අත්සන</div>
          <div class="sig"><img src="${sigData}" alt="signature" style="max-width:100%;height:auto;display:block"/></div>
        </div>
        <div style="margin-top:22px;color:#666">මෙම ආදේශනය බලගතු ලෙස සුරක්ෂිතව සකසා ඇත.</div>
      </div>
      <script>window.print()</script>
      </body></html>
    `;
    win.document.open();
    win.document.write(html);
    win.document.close();

    return false;
  }

  // helper: detect blank canvas (simple)
  function isCanvasBlank(c) {
    const blank = document.createElement('canvas');
    blank.width = c.width;
    blank.height = c.height;
    const bctx = blank.getContext('2d');
    bctx.fillStyle = "#ffffff";
    bctx.fillRect(0,0, blank.width, blank.height);
    // compare data URLs
    return c.toDataURL() === blank.toDataURL();
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  document.getElementById('printBtn').addEventListener('click', () => window.print());

</script>
</body>
</html>
